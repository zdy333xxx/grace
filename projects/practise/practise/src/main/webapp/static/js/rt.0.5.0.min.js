/*!
 rt.js
 @homepage:https://github.com/zhanhongtao/rt.js
 @update: 2014-06-11
 */
!function (a, b) {
    if ("object" == typeof exports && exports)
        b(exports);
    else {
        var c = {};
        b(c), "function" == typeof define && define.amd ? define(c) : a.rt = c
    }
}(this, function (a) {
    "use strict";
    function b(a) {
        this.string = a, this.tail = a, this.pos = 0
    }
    function c(a) {
        return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&")
    }
    function d(a) {
        if (!k(a) || 2 !== a.length)
            throw new Error("Invalid tags: " + a);
        return[new RegExp(c(a[0]) + "\\s*"), new RegExp("\\s*" + c(a[1]))]
    }
    function e(c, e) {
        e = e || a.tags, c = c || "", "string" == typeof e && (e = e.split(o));
        for (var f, h, i, j, k = d(e), l = new b(c), m = []; !l.eos() && (f = l.pos, i = l.scanUntil(k[0]), i && (m.push(["text", i, f, f + i.length]), f += i.length), l.scan(k[0])); ) {
            if (h = l.scan(q) || "name", l.scan(n), "@" === h ? (i = l.scanUntil(p), l.scan(p), l.scanUntil(k[1])) : i = l.scanUntil(k[1]), !l.scan(k[1]))
                throw new Error("Unclosed tag at " + l.pos);
            j = [h, i, f, l.pos], m.push(j), "@" === h && (k = d(e = i.split(o)))
        }
        return g(m)
    }
    function f(a, b) {
        return"(function() { " + e(a) + "}).call(" + b + ");"
    }
    function g(a) {
        for (var b = "var output = '', helper = this;", c = 0, d = a.length; d > c; c++) {
            var e = a[c];
            if (e) {
                var g = e[1], h = /text|\^/;
                if (h.test(e[0]) && (g = g.replace(l, function (a) {
                    return"\\" + m[a]
                })), "" !== g)
                    switch (e[0]) {
                        case"name":
                            b += "\n" + g + "\n";
                            break;
                        case">":
                            b += "output += " + f(s.include(g), "helper") + ";";
                            break;
                        case"=":
                            b += "output += helper.escape(" + g + ");";
                            break;
                        case":=":
                            b += "output += helper.unicode(" + g + ");";
                            break;
                        case"&":
                            b += "output += " + g + ";";
                            break;
                        case"text":
                            b += "output += '" + g + "';"
                        }
            }
        }
        return b += "return output;"
    }
    function h(a, b, c, d, e, f) {
        if ("string" != typeof a)
            return"";
        b = +b || 16, c = "string" == typeof c ? c : "&#x", d = "string" == typeof d ? d : ";", "undefined" == typeof e && (e = 3), f = "function" == typeof f ? f : function () {
        };
        for (var g, h = "", i = 0, j = 0, k = a.length; k > j; j++)
            g = f(a.charAt(j)), "string" != typeof g && (g = a.charCodeAt(j).toString(b), i = e - String(g).length + 1, 1 > i && (i = 0), g = c + new Array(i).join("0") + g + d), h += g, i = 0;
        return h
    }
    function i(a) {
        return String(a).replace(/[&<>"'\/\\%]/g, function (a) {
            return r[a]
        })
    }
    b.prototype.eos = function () {
        return"" === this.tail
    }, b.prototype.scan = function (a) {
        var b = this.tail.match(a);
        if (b && 0 === b.index) {
            var c = b[0];
            return this.tail = this.tail.substring(c.length), this.pos += c.length, c
        }
        return""
    }, b.prototype.scanUntil = function (a) {
        var b, c = this.tail.search(a);
        switch (c) {
            case-1:
                b = this.tail, this.tail = "";
                break;
            case 0:
                b = "";
                break;
            default:
                b = this.tail.substring(0, c), this.tail = this.tail.substring(c)
        }
        return this.pos += b.length, b
    };
    var j = Object.prototype.toString, k = Array.isArray || function (a) {
        return"[object Array]" === j.call(a)
    }, l = /\\|'|"|\r|\n|\u2028|\u2029/g, m = {"'": "'", '"': '"', "\\": "\\", "\r": "r", "\n": "n", "\u2028": "u2028", "\u2029": "u2029"}, n = /\s*/, o = /\s+/, p = /\s*@/, q = /#|=|:=|&|@|>/;
    a.tags = ["<%", "%>"], a.cache = {}, a.debug = 0;
    var r = {"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#x27;", "/": "&#x2f;", "\\": "&#x5c;", "%": "&#x0025;"}, s = {};
    a.helper = function (a, b) {
        s[a] = "function" == typeof b ? b : function () {
        }
    }, a.helper("escape", i), a.helper("include", function (b) {
        var c, d = "";
        try {
            c = document.getElementById(b), d = /input|textarea/i.test(c.nodeName) ? c.value : c.innerHTML
        } catch (e) {
            if (a.debug)
                throw e
        }
        return d
    }), a.helper("unicode", function (a) {
        return h(a, 16, "\\u", "", 4)
    }), a.compile = function (b, c) {
        var d = this.cache[c] || this.cache[b];
        if (d)
            return d;
        var f = e(b), g = function () {
        };
        try {
            g = new Function("it", f)
        } catch (h) {
            if (a.debug)
                throw h
        }
        return this.cache[c ? c : b] = g
    }, a.render = function (a, b, c) {
        var d = this.compile(a, c);
        return d.call(s, b)
    }, a.template = function () {
        return(arguments.length > 1 ? a.render : a.compile).apply(a, arguments)
    }
});